#!/bin/bash

# Скрипт для автоматического и надежного развертывания телеграм-бота

echo "--- Запуск развертывания: $(date) ---"

# Переходим в директорию проекта
cd ~/telegram-app || exit

echo "Текущая директория: $(pwd)"
echo "Выполняется от пользователя: $(whoami)"

echo "Шаг 1: Отмена всех локальных изменений...."
git reset --hard HEAD

echo "Шаг 2: Удаление всех неотслеживаемых файлов..."
git clean -f -d

echo "Шаг 3: Загрузка последних изменений с GitHub..."
#
# ВНИМАНИЕ: Убедись, что твоя ветка называется 'master'.
# Если она называется 'main', замени 'master' на 'main' в строке ниже.
#
git pull origin master

echo "Шаг 4: Установка или обновление зависимостей..."
# Используем полный путь к npm, чтобы избежать проблем с переменной PATH
/home/admin/.nvm/versions/node/v22.17.0/bin/npm install

echo "Шаг 5: Перезагрузка приложения через PM2..."
# Используем 'reload' для "бесшовного" перезапуска без остановки
/home/admin/.nvm/versions/node/v22.17.0/bin/pm2 reload ecosystem.config.js

echo "Шаг 6: Сохранение списка процессов PM2...."
/home/admin/.nvm/versions/node/v22.17.0/bin/pm2 save

echo "--- Развертывание успешно завершено ---"