#!/bin/bash

# Скрипт для автоматического и надежного развертывания телеграм-бота

# Переходим в директорию проекта
cd ~/telegram-app || exit

echo "Шаг 1: Отмена всех локальных изменений...."
git reset --hard HEAD

echo "Шаг 2: Удаление всех неотслеживаемых файлов..."
git clean -f -d

echo "Шаг 3: Загрузка последних изменений с GitHub..."
# Убедись, что ты используешь правильную ветку (master или main)
git pull origin master

echo "Шаг 4: Установка или обновление зависимостей..."
# Используем полный путь к npm, чтобы избежать проблем с переменной PATH
/home/admin/.nvm/versions/node/v22.17.0/bin/npm install

echo "Шаг 5: Перезапуск приложения через PM2 с использованием ecosystem файла..."
# Это более надежный способ перезапуска.
# Он перезапустит приложение с настройками из файла ecosystem.config.js
/home/admin/.nvm/versions/node/v22.17.0/bin/pm2 restart ecosystem.config.js

echo "Развертывание успешно завершено в $(date)"