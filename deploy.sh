#!/bin/bash

# Скрипт для автоматического и надежного развертывания телеграм-бота

# Переходим в директорию проекта
cd ~/telegram-app || exit

echo "Шаг 1: Отмена всех локальных изменений..."
# Эта команда удаляет любые случайные изменения на сервере,
# чтобы они не конфликтовали с обновлением.
git reset --hard HEAD

echo "Шаг 2: Удаление всех неотслеживаемых файлов..."
# Эта команда удаляет новые файлы, которые могли быть созданы на сервере
# и которые могут помешать git pull.
git clean -f -d

echo "Шаг 3: Загрузка последних изменений с GitHub..."
# Забираем последнюю версию кода из ветки main
git pull origin master

echo "Шаг 4: Установка или обновление зависимостей..."
# Используем полный путь к npm, чтобы избежать проблем с переменной PATH
/home/admin/.nvm/versions/node/v22.17.0/bin/npm install

echo "Шаг 5: Перезапуск приложения через PM2..."
# Перезапускаем процесс по имени, указанному в ecosystem.config.js
/home/admin/.nvm/versions/node/v22.17.0/bin/pm2 restart telegram-bot

echo "Развертывание успешно завершено в $(date)"

