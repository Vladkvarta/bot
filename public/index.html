<!DOCTYPE html>
<html lang="uk">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sweet Delights</title>
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@400;500;600;700&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#FFD700",
            secondary: "#1a1a1a",
          },
          borderRadius: {
            none: "0px",
            sm: "4px",
            DEFAULT: "8px",
            md: "12px",
            lg: "16px",
            xl: "20px",
            "2xl": "24px",
            "3xl": "32px",
            full: "9999px",
            button: "8px",
          },
        },
      },
    };
  </script>
  <style>
    :where([class^="ri-"])::before {
      content: "\f3c2";
    }

    body {
      font-family: 'Montserrat', sans-serif;
    }

    .logo-font {
      font-family: 'Pacifico', serif;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>

<body class="bg-gray-50 text-secondary">
  <header class="fixed top-0 w-full bg-white shadow-sm z-50">
    <div class="flex items-center justify-between px-4 py-3">
      <div class="flex items-center space-x-2">
        <span class="logo-font text-xl text-secondary">Sweet Delights</span>
      </div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center">
          <span id="cart-total" class="text-sm font-medium text-secondary mr-2 hidden">₴ 0</span>
          <div class="relative">
            <div class="w-6 h-6 flex items-center justify-center cursor-pointer">
              <i class="ri-shopping-cart-line text-xl"></i>
            </div>
            <div id="cart-badge"
              class="absolute -top-2 -right-2 bg-primary text-secondary text-xs rounded-full w-5 h-5 flex items-center justify-center font-medium hidden">
              0
            </div>
          </div>
        </div>
        <div class="w-6 h-6 flex items-center justify-center cursor-pointer">
          <i class="ri-close-line text-xl"></i>
        </div>
      </div>
    </div>
  </header>
  <main class="pt-16 pb-20">
    <div class="px-4 py-4">
      <div class="flex space-x-1.5 overflow-x-auto pb-2 mb-6 no-scrollbar">
        <button
          class="category-btn bg-primary text-secondary px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap active"
          data-category="all">
          Усі
        </button>
        <button
          class="category-btn bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
          data-category="cakes">
          Торти
        </button>
        <button
          class="category-btn bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
          data-category="cookies">
          Печиво
        </button>
        <button
          class="category-btn bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
          data-category="pastries">
          Випічка
        </button>
        <button
          class="category-btn bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
          data-category="ice-cream">
          Морозиво
        </button>
        <button
          class="category-btn bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
          data-category="drinks">
          Напої
        </button>
        <button
          class="category-btn bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap"
          data-category="other">
          Інше
        </button>
      </div>
      <div class="grid grid-cols-2 gap-4" id="products-grid">
        <p class="col-span-2 text-center text-gray-500 py-10">Завантаження каталогу...</p>
      </div>
    </div>
  </main>
  <footer class="fixed bottom-0 w-full bg-white p-4 z-50 border-t">
    <button id="view-order-btn"
      class="w-full bg-secondary text-white py-3 rounded-lg font-semibold text-sm cursor-pointer">
      ПЕРЕГЛЯНУТИ ЗАМОВЛЕННЯ
    </button>
  </footer>
  <script id="product-loader">
    document.addEventListener('DOMContentLoaded', async () => {
      const productsGrid = document.getElementById('products-grid');
      let allProducts = [];

      // 1. Функция для загрузки данных с сервера
      async function fetchProducts() {
        try {
          const response = await fetch('/api/products');
          if (!response.ok) throw new Error('Ошибка сети');
          allProducts = await response.json();
        } catch (error) {
          console.error('Ошибка загрузки товаров:', error);
          productsGrid.innerHTML = '<p class="col-span-2 text-center text-red-500">Помилка завантаження каталогу.</p>';
        }
      }

      // 2. Функция для создания HTML-кода карточек
      function renderProducts() {
        productsGrid.innerHTML = ''; // Очищаем сообщение "Завантаження..."
        allProducts.forEach(product => {
          const card = document.createElement('div');
          // Устанавливаем классы и data-атрибуты, как в вашем статичном примере
          card.className = 'bg-white rounded-lg shadow-sm overflow-hidden product-card cursor-pointer flex flex-col';
          card.dataset.category = product.category.toLowerCase(); // Для фильтра категорий

          const isOutOfStock = product.stock.status === 'out_of_stock';

          // Используем HTML-шаблон, который вы предоставили
          card.innerHTML = `
          <div class="relative">
            <img src="${product.images[0].url}" alt="${product.name}" class="w-full h-32 object-cover object-top ${isOutOfStock ? 'grayscale' : ''}">
            ${product.isNew ? `<div class="absolute top-2 right-2 bg-primary text-secondary text-xs px-2 py-1 rounded-full font-medium">НОВИНКА</div>` : ''}
            ${isOutOfStock ? `<div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center"><span class="text-white font-bold text-center">Немає в наявності</span></div>` : ''}
          </div>
          <div class="p-3 flex flex-col flex-1">
            <div class="flex-1">
              <h3 class="font-medium text-sm mb-1">${product.name}</h3>
              <p class="text-gray-600 text-xs">₴ ${product.price}</p>
            </div>
            <div class="flex items-center justify-center pt-2">
              ${!isOutOfStock ? `
              <div class="quantity-controls hidden flex items-center space-x-2">
                <button class="quantity-btn bg-red-500 text-white w-6 h-6 rounded flex items-center justify-center text-sm"><i class="ri-subtract-line"></i></button>
                <span class="quantity text-sm font-medium min-w-[20px] text-center">1</span>
                <button class="quantity-btn bg-emerald-500 text-white w-6 h-6 rounded flex items-center justify-center text-sm"><i class="ri-add-line"></i></button>
              </div>
              <button class="add-to-cart bg-primary text-secondary px-3 py-1 rounded-lg text-xs font-medium cursor-pointer w-full">ДОДАТИ</button>
              ` : ''}
            </div>
          </div>
        `;
          productsGrid.appendChild(card);
        });
      }

      // 3. Запускаем процесс
      await fetchProducts();
      renderProducts();

      // ВАЖНО: После того как мы создали карточки, нужно "разбудить"
      // ваши остальные скрипты, чтобы они нашли новые кнопки.
      // Мы создаем и отправляем специальное событие.
      document.dispatchEvent(new Event('productsRendered'));
    });
  </script>
  <script id="category-filter">
    document.addEventListener('productsRendered', function () {
      const categoryBtns = document.querySelectorAll(".category-btn");
      const productCards = document.querySelectorAll(".product-card");
      categoryBtns.forEach((btn) => {
        btn.addEventListener("click", function () {
          categoryBtns.forEach((b) => {
            b.classList.remove("bg-primary", "text-secondary", "active");
            b.classList.add("bg-gray-200", "text-gray-700");
          });
          this.classList.remove("bg-gray-200", "text-gray-700");
          this.classList.add("bg-primary", "text-secondary", "active");
          const category = this.dataset.category;
          productCards.forEach((card) => {
            if (category === "all" || card.dataset.category === category) {
              card.style.display = "block";
            } else {
              card.style.display = "none";
            }
          });
        });
      });
    });
  </script>
  <script id="quantity-controls">
    document.addEventListener('productsRendered', function () {
      let pressTimer;
      const updateQuantity = (btn, isIncrement) => {
        const card = btn.closest(".product-card");
        const quantitySpan = card.querySelector(".quantity");
        let quantity = parseInt(quantitySpan.textContent);
        if (isIncrement) {
          quantity++;
        } else if (quantity > 0) {
          quantity--;
        }
        quantitySpan.textContent = quantity;
        if (quantity === 0) {
          const controls = card.querySelector(".quantity-controls");
          const addBtn = card.querySelector(".add-to-cart");
          controls.classList.add("hidden");
          addBtn.classList.remove("hidden");
        }
        updateCartBadge();
      };
      document.querySelectorAll(".quantity-btn").forEach((btn) => {
        const isIncrement = btn.querySelector(".ri-add-line") !== null;
        btn.addEventListener("mousedown", (e) => {
          e.stopPropagation();
          updateQuantity(btn, isIncrement);
          pressTimer = setInterval(() => {
            updateQuantity(btn, isIncrement);
          }, 150);
        });
        btn.addEventListener("mouseup", () => {
          clearInterval(pressTimer);
        });
        btn.addEventListener("mouseleave", () => {
          clearInterval(pressTimer);
        });
        btn.addEventListener("touchstart", (e) => {
          e.stopPropagation();
          updateQuantity(btn, isIncrement);
          pressTimer = setInterval(() => {
            updateQuantity(btn, isIncrement);
          }, 150);
        });
        btn.addEventListener("touchend", () => {
          clearInterval(pressTimer);
        });
      });
    });
  </script>
  <script id="cart-management">
    document.addEventListener('productsRendered', function () {
      const addToCartBtns = document.querySelectorAll(".add-to-cart");
      addToCartBtns.forEach((btn) => {
        btn.addEventListener("click", function (e) {
          e.stopPropagation();
          const card = this.closest(".product-card");
          const quantitySpan = card.querySelector(".quantity");
          const controls = card.querySelector(".quantity-controls");
          quantitySpan.textContent = "1";
          controls.classList.remove("hidden");
          this.classList.add("hidden");
          updateCartBadge();
        });
      });
      function updateCartBadge() {
        const quantities = document.querySelectorAll(".quantity");
        let uniqueItems = 0;
        let total = 0;

        quantities.forEach((q) => {
          const quantity = parseInt(q.textContent);
          if (quantity > 0) {
            uniqueItems++;
            const price = parseInt(
              q
                .closest(".product-card")
                .querySelector(".text-gray-600")
                .textContent.replace("₴", "")
                .trim(),
            );
            total += quantity * price;
          }
        });

        const badge = document.getElementById("cart-badge");
        const cartTotal = document.getElementById("cart-total");

        if (uniqueItems > 0) {
          badge.textContent = uniqueItems;
          badge.classList.remove("hidden");
          cartTotal.textContent = `₴ ${total}`;
          cartTotal.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
          cartTotal.classList.add("hidden");
        }
      }
      window.updateCartBadge = updateCartBadge;
    });
  </script>
  <script id="order-view">
    document.addEventListener('productsRendered', function () {
      const viewOrderBtn = document.getElementById("view-order-btn");
      const orderLink = viewOrderBtn.closest("a");
      viewOrderBtn.addEventListener("click", function (e) {
        const quantities = document.querySelectorAll(".quantity");
        let hasItems = false;
        quantities.forEach((q) => {
          if (parseInt(q.textContent) > 0) {
            hasItems = true;
          }
        });
        if (!hasItems) {
          e.preventDefault();
          orderLink.removeAttribute("href");
          console.log("Кошик порожній");
        } else {
          orderLink.setAttribute(
            "href",
            "https://readdy.ai/home/cb9458f8-9101-4315-a4f7-32608dd27b3b/55633c83-4ac9-46e4-80c0-900a7f2ca473",
          );
        }
      });
    });
  </script>
</body>

</html>